services:
  keycloak:
    container_name: keycloak
    image: ghcr.io/open-dpp/open-dpp-auth:main@sha256:0ae4ae1dcfae9bf6e99ad296f675e97b64af58d12d0ed5bf4e0e8da70055abff
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin
      - KC_HEALTH_ENABLED=true
      - KC_HOSTNAME_DEBUG=true
      - KC_HOSTNAME_STRICT=false
      - KC_HTTP_ENABLED=true
      - PROXY_ADDRESS_FORWARDING=true
      - MANAGEMENT_ROOT_URL=http://localhost:20004
      - KC_PROXY_HEADERS=xforwarded
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://auth-db/auth
      - KC_DB_USERNAME=postgres
      - KC_DB_PASSWORD=secretPassword!
      - SMTP_HOST=someHost
      - SMTP_PORT=922
      - SMTP_USER=user@example.com
      - SMTP_PASSWORD=emailPassword!
      - SMTP_FROM=user@example.com
      - SMTP_TLS=true
    ports:
      - "20000:8080"
    healthcheck:
      test: [ "CMD-SHELL", "java -jar /opt/healthcheck/healthcheck.jar http://127.0.0.1:8080/realms/open-dpp" ]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 30s
    command: start-dev --import-realm

  auth-db:
    container_name: auth-db
    image: postgres:17-alpine
    environment:
      - POSTGRES_DB=auth
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=secretPassword!

  api-db:
    container_name: api-db
    platform: linux/amd64 #for platform error on Apple M1 chips
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: 'open-dpp'
      POSTGRES_PASSWORD: 'open-dpp'
      POSTGRES_DB: 'open-dpp'
    ports:
      - '20003:5432'

